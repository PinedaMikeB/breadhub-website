<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BreadHub - Loyverse Mapping Setup</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #f39c12; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #27ae60; }
        .error { background: #e74c3c; }
        .info { background: #3498db; }
        .warning { background: #f39c12; color: #000; }
        button { background: #f39c12; color: #000; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 5px; }
        button:hover { background: #e67e22; }
        button:disabled { background: #666; cursor: not-allowed; }
        #log { background: #0a0a15; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 2px 0; padding: 2px 5px; }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        .log-warning { color: #f39c12; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #2c3e50; }
        .mapped { color: #2ecc71; }
        .unmapped { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>üçû BreadHub - Loyverse Product Mapping Setup</h1>
    
    <div class="status info">
        This tool will automatically map your Loyverse products to ProofMaster products.
    </div>
    
    <div style="margin: 20px 0;">
        <button onclick="loadProducts()">1. Load ProofMaster Products</button>
        <button onclick="createMappings()" id="mapBtn" disabled>2. Create Mappings</button>
        <button onclick="clearMappings()">Clear All Mappings</button>
    </div>
    
    <div id="stats" style="display:none;">
        <h3>üìä Statistics</h3>
        <p>ProofMaster Products: <span id="pmCount">0</span></p>
        <p>Loyverse Items: <span id="loyCount">160</span></p>
        <p>Mapped: <span id="mappedCount">0</span></p>
    </div>
    
    <div id="log"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase config
        firebase.initializeApp({
            apiKey: "AIzaSyAj2szYv9ynVFrxdH0tpUsOg7JmJn6Wq0g",
            authDomain: "breadhub-proofmaster.firebaseapp.com",
            projectId: "breadhub-proofmaster",
            storageBucket: "breadhub-proofmaster.firebasestorage.app",
            messagingSenderId: "222137689770",
            appId: "1:222137689770:web:645c552afa835732c852d3"
        });
        const db = firebase.firestore();
        
        let proofmasterProducts = [];
        
        // Loyverse product names from your CSV
        const loyverseItems = [
            "1 Creamer And 1 Sugar",
            "Alcapone",
            "Alcapone Classic",
            "Avocado Shake (12 oz)",
            "Avocado Shake (16 oz)",
            "Avocado Shake (22 oz)",
            "Bacon And Cheese",
            "Banana Bread Almond",
            "Banana Bread White Choco Chip (Chocochip)",
            "Banana Bread White Choco Chip (Walnut)",
            "Banana Walnut Choco Bread",
            "Bavarian Donut Classic",
            "Biggest Box",
            "Birthday Donut Classic",
            "Biscof Cinnamon",
            "Biscoff Donut Classic",
            "Biscoff Donut Premium",
            "Biscoff Frappe (Grande 16 oz)",
            "Biscoff Frappe (Venti 22 oz)",
            "Blueberry Cinnamon",
            "Blueberry Donut Premium",
            "Blueberry Fizz (12 oz)",
            "Blueberry Fizz (16 oz)",
            "Blueberry Fizz (22 oz)",
            "Blueberry Shake (22 oz)",
            "Blueberry Yogurt Drink (Grande 16 oz)",
            "Blueberry Yogurt Drink (Venti 22 oz)",
            "Bottled Water",
            "Box Christmas Large",
            "Box of 12",
            "Box of 6",
            "Brewed Coffee (12 oz)",
            "Brewed Coffee (8 oz)",
            "Butter Melt Cheese Roll",
            "C2 Solo",
            "Cheese Bread",
            "Cheesy Dog Twist",
            "Chicken Floss",
            "Chill Start",
            "Choco Bread",
            "Choco Cinnamon Bread",
            "Choco Glaze",
            "ChocoChip cookies",
            "Cinnamon Gift Bundle 4PC",
            "Cinnamon Glaze",
            "Cinnamon Roll",
            "Classic Wakeup",
            "Coffee Bun",
            "Coke Sakto",
            "Condensed Sweetener (22 oz - 90ml)",
            "Crinkles",
            "Crispy Egg Cheese Toast",
            "Custard",
            "Double Cheese Pandesal",
            "Ensaymada Parmy",
            "Espresso (1 Shot)",
            "Espresso (2 Shots)",
            "Event Hot Choco (8 oz)",
            "Grab A Bundle",
            "Grab B Bundle",
            "Grab C Bacon And Cheese",
            "Grab C Ham & Cheese",
            "Grab C Pig in a Blanket",
            "Grab C Spam And Cheese",
            "Grab C Tuna Melt",
            "Green Apple Fizz (12 oz)",
            "Green Apple Fizz (16 oz)",
            "Green Apple Fizz (22 oz)",
            "Ham And Cheese",
            "Honey Garlic Toast",
            "Hot Cafe Americano (12 oz)",
            "Hot Cafe Americano (8 oz)",
            "Hot Cafe Latte (12 oz)",
            "Hot Cafe Latte (8 oz)",
            "Hot Cappucino (12 oz)",
            "Hot Cappucino (8 oz)",
            "Hot Caramel Machiato (12 oz)",
            "Hot Caramel Machiato (8 oz)",
            "Hot Matcha Latte (12 oz)",
            "Hot Matcha Latte (8 oz)",
            "Hot Milk (8 oz)",
            "Hot Spanish Latte (12 oz)",
            "Hot Spanish Latte (8 oz)",
            "Iced Brewed Coffee (12 oz)",
            "Iced Brewed Coffee (16 oz)",
            "Iced Cafe Americano (12 oz)",
            "Iced Cafe Americano (16 oz)",
            "Iced Cafe Americano (22 oz)",
            "Iced Cafe Latte (12 oz)",
            "Iced Cafe Latte (16 oz)",
            "Iced Cafe Latte (22 oz)",
            "Iced Cappucino (12 oz)",
            "Iced Cappucino (16 oz)",
            "Iced Cappucino (22 oz)",
            "Iced Caramel Machiatto (12 oz)",
            "Iced Caramel Machiatto (16 oz)",
            "Iced Caramel Machiatto (22 oz)",
            "Iced Matcha Latte (12 oz)",
            "Iced Matcha Latte (16 oz)",
            "Iced Matcha Latte (22 oz)",
            "Iced Spanish Latte (12 oz)",
            "Iced Spanish Latte (16 oz)",
            "Iced Spanish Latte (22 oz)",
            "Kiwi Fizz (12 oz)",
            "Kiwi Fizz (16 oz)",
            "Kiwi Fizz (22 oz)",
            "Lemon Fizz (12 oz)",
            "Lemon Fizz (16 oz)",
            "Lemon Fizz (22 oz)",
            "Lychee Fizz (12 oz)",
            "Lychee Fizz (16 oz)",
            "Lychee Fizz (22 oz)",
            "Malunggay Cheese Pandesal",
            "Mango Cinnamon",
            "Mango Yogurt Drink (Grande 16 oz)",
            "Mango Yogurt Drink (Venti 22 oz)",
            "Milky Cheesy Roll",
            "Mocha Chiffon",
            "Monggo Basket",
            "Morning Boost",
            "Nuttela Donut Classic",
            "Nuttella Donut Premium",
            "Oreo Cream Donut Premium",
            "Pan De Coco",
            "Peach Fizz (12 oz)",
            "Peach Fizz (16 oz)",
            "Peach Fizz (22 oz)",
            "Pig In A Blanket",
            "Pistachio Donut",
            "Pork Floss",
            "Pudding",
            "Royal Sakto",
            "S'mores Donut Classic",
            "Spam And Cheese",
            "Spanish Bread",
            "Spicy Pork Floss",
            "Spring In The City",
            "Sprinkle Donut",
            "Sprite Sakto",
            "Strawberry Bavarian Donut Classic",
            "Strawberry Cinnamon",
            "Strawberry Fizz (12 oz)",
            "Strawberry Fizz (16 oz)",
            "Strawberry Fizz (22 oz)",
            "Strawberry Frappe (Grande 16 oz)",
            "Strawberry Frappe (Venti 22 oz)",
            "Strawberry Shake (16 oz)",
            "Strawberry Yogurt Drink (Grande 16 oz)",
            "Strawberry Yogurt Drink (Venti 22 oz)",
            "Sweet Drizzle Cinnamon",
            "Tasty Loaf",
            "Tiramisu Cinnamon",
            "Tiramisu Donut",
            "Tiramisu Donut Classic",
            "Tuna Melt",
            "Ube Twist",
            "Vanilla Chiffon",
            "White Almond",
            "White Chocochip Cookie"
        ];
        
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function loadProducts() {
            log('Loading ProofMaster products...', 'info');
            try {
                const snapshot = await db.collection('products').get();
                proofmasterProducts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                log(`Loaded ${proofmasterProducts.length} ProofMaster products`, 'success');
                document.getElementById('pmCount').textContent = proofmasterProducts.length;
                document.getElementById('stats').style.display = 'block';
                document.getElementById('mapBtn').disabled = false;
                
                // List products
                proofmasterProducts.forEach(p => {
                    log(`  - ${p.name} (${p.category})`, 'info');
                });
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function normalize(str) {
            return str.toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .replace(/\s+/g, '');
        }
        
        function findMatch(loyverseName) {
            const loyNorm = normalize(loyverseName);
            let bestMatch = null;
            let bestScore = 0;
            
            for (const p of proofmasterProducts) {
                // Direct name match
                const pNorm = normalize(p.name);
                
                // Exact match
                if (loyNorm === pNorm) {
                    return { product: p, variantIndex: null, score: 1.0 };
                }
                
                // Contains match
                if (loyNorm.includes(pNorm) || pNorm.includes(loyNorm)) {
                    const score = Math.min(loyNorm.length, pNorm.length) / Math.max(loyNorm.length, pNorm.length);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = { product: p, variantIndex: null, score };
                    }
                }
                
                // Check variants
                if (p.hasVariants && p.variants) {
                    for (let i = 0; i < p.variants.length; i++) {
                        const v = p.variants[i];
                        const fullNorm = normalize(p.name + ' ' + v.name);
                        const vNorm = normalize(v.name);
                        
                        if (loyNorm === fullNorm || loyNorm.includes(fullNorm) || fullNorm.includes(loyNorm)) {
                            return { product: p, variantIndex: i, score: 0.95 };
                        }
                        
                        // Size matching for drinks (12oz, 16oz, 22oz)
                        if (loyverseName.includes('oz)')) {
                            const sizeMatch = loyverseName.match(/\((\d+)\s*oz\)/i);
                            if (sizeMatch) {
                                const size = sizeMatch[1];
                                if (v.name && v.name.includes(size)) {
                                    const baseMatch = loyNorm.replace(/\d+oz/g, '').includes(pNorm.replace(/\d+oz/g, ''));
                                    if (baseMatch || pNorm.includes(loyNorm.split('(')[0].trim().replace(/[^a-z0-9]/g, ''))) {
                                        return { product: p, variantIndex: i, score: 0.9 };
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            return bestMatch && bestScore > 0.5 ? bestMatch : null;
        }
        
        async function createMappings() {
            log('Creating mappings...', 'info');
            let mapped = 0;
            let unmapped = 0;
            
            for (const loyName of loyverseItems) {
                const match = findMatch(loyName);
                
                if (match && match.score >= 0.5) {
                    try {
                        // Check if mapping already exists
                        const existing = await db.collection('productMapping')
                            .where('loyverseName', '==', loyName)
                            .get();
                        
                        if (!existing.empty) {
                            log(`Already mapped: ${loyName}`, 'warning');
                            mapped++;
                            continue;
                        }
                        
                        const variantName = match.variantIndex !== null && match.product.variants
                            ? match.product.variants[match.variantIndex].name
                            : null;
                        
                        await db.collection('productMapping').add({
                            loyverseName: loyName,
                            productId: match.product.id,
                            productName: match.product.name,
                            variantIndex: match.variantIndex,
                            variantName: variantName,
                            category: match.product.category,
                            mainCategory: match.product.mainCategory,
                            score: match.score,
                            createdAt: new Date().toISOString()
                        });
                        
                        log(`‚úì ${loyName} ‚Üí ${match.product.name}${variantName ? ' (' + variantName + ')' : ''} (${Math.round(match.score * 100)}%)`, 'success');
                        mapped++;
                    } catch (error) {
                        log(`Error mapping ${loyName}: ${error.message}`, 'error');
                    }
                } else {
                    log(`‚úó No match: ${loyName}`, 'error');
                    unmapped++;
                }
            }
            
            log(`Done! Mapped: ${mapped}, Unmapped: ${unmapped}`, mapped > unmapped ? 'success' : 'warning');
            document.getElementById('mappedCount').textContent = mapped;
        }
        
        async function clearMappings() {
            if (!confirm('Delete ALL product mappings?')) return;
            
            log('Clearing all mappings...', 'warning');
            try {
                const snapshot = await db.collection('productMapping').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                log(`Deleted ${snapshot.size} mappings`, 'success');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
